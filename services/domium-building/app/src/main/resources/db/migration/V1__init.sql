CREATE EXTENSION IF NOT EXISTS "pgcrypto";

CREATE TABLE IF NOT EXISTS buildings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    version BIGINT NOT NULL DEFAULT 0,

    project_id UUID,
    client_id UUID,
    manager_id UUID,
    workflow_id UUID,

    current_stage_id UUID,
    current_stage_name TEXT,
    current_stage_index INT NOT NULL DEFAULT 0,
    progress INT NOT NULL DEFAULT 0,
    status TEXT NOT NULL DEFAULT 'ACTIVE',
    created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_buildings_client_id ON buildings(client_id);
CREATE INDEX IF NOT EXISTS idx_buildings_project_id ON buildings(project_id);
CREATE INDEX IF NOT EXISTS idx_buildings_workflow_id ON buildings(workflow_id);

CREATE TABLE IF NOT EXISTS building_workflows (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    manager_id UUID NOT NULL,
    name TEXT NOT NULL,
    active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

CREATE UNIQUE INDEX IF NOT EXISTS uq_building_workflows_manager_active
    ON building_workflows(manager_id)
    WHERE active = true;

CREATE TABLE IF NOT EXISTS workflow_stages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    workflow_id UUID NOT NULL,
    name TEXT NOT NULL,
    description TEXT,
    planned_days INT NOT NULL DEFAULT 0,
    position INT NOT NULL
);

CREATE UNIQUE INDEX IF NOT EXISTS uq_workflow_stages_workflow_position
    ON workflow_stages(workflow_id, position);
CREATE UNIQUE INDEX IF NOT EXISTS uq_workflow_stages_workflow_name
    ON workflow_stages(workflow_id, name);

CREATE TABLE IF NOT EXISTS workflow_tasks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    stage_id UUID NOT NULL,
    parent_id UUID,
    type TEXT NOT NULL,
    name TEXT NOT NULL,
    description TEXT,
    position INT NOT NULL
);

CREATE UNIQUE INDEX IF NOT EXISTS uq_workflow_tasks_stage_parent_position
    ON workflow_tasks(stage_id, parent_id, position);
CREATE UNIQUE INDEX IF NOT EXISTS uq_workflow_tasks_stage_parent_name
    ON workflow_tasks(stage_id, parent_id, name);

CREATE TABLE IF NOT EXISTS building_task_completions (
    building_id UUID NOT NULL,
    task_id UUID NOT NULL,
    completed_by UUID,
    completed_at TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT NOW(),
    PRIMARY KEY (building_id, task_id)
);

CREATE INDEX IF NOT EXISTS idx_building_task_completions_building_id
    ON building_task_completions(building_id);

CREATE TABLE IF NOT EXISTS building_projections (
    id UUID PRIMARY KEY,
    project_id UUID,
    project_name TEXT,
    client_id UUID,
    manager_id UUID,
    manager_name TEXT,
    stage TEXT,
    progress INT NOT NULL DEFAULT 0,
    video_url TEXT,
    updated_at TIMESTAMP WITHOUT TIME ZONE,
    metadata JSONB NOT NULL DEFAULT '{}'::jsonb
);

CREATE INDEX IF NOT EXISTS idx_building_projections_client_id ON building_projections(client_id);
CREATE INDEX IF NOT EXISTS idx_building_projections_manager_id ON building_projections(manager_id);
CREATE INDEX IF NOT EXISTS idx_building_projections_project_id ON building_projections(project_id);


INSERT INTO building_workflows (id, manager_id, name, active, created_at)
VALUES (
    '11111111-1111-1111-1111-111111111111',
    '00000000-0000-0000-0000-000000000000',
    'DEFAULT',
    true,
    NOW()
)
ON CONFLICT (id) DO NOTHING;

INSERT INTO workflow_stages (id, workflow_id, name, description, planned_days, position)
VALUES
    -- 1. Подготовительный этап
    ('22222222-2222-2222-2222-222222222221', '11111111-1111-1111-1111-111111111111', 'Подготовительный этап', 'Выбор участка + проектирование (проверки документов, геология, согласования, разрешение на строительство)', 3, 0),
    -- 2. Строительные работы
    ('22222222-2222-2222-2222-222222222222', '11111111-1111-1111-1111-111111111111', 'Земляные работы', 'Расчистка и разметка, котлован/траншея, опалубка, арматура, заливка основания', 3, 1),
    ('22222222-2222-2222-2222-222222222223', '11111111-1111-1111-1111-111111111111', 'Возведение стен и перекрытий', 'Несущие конструкции, перекрытия, лестницы, перегородки', 3, 2),
    ('22222222-2222-2222-2222-222222222224', '11111111-1111-1111-1111-111111111111', 'Монтаж крыши', 'Стропильная система, кровля, водосток, утепление', 3, 3),
    ('22222222-2222-2222-2222-222222222225', '11111111-1111-1111-1111-111111111111', 'Установка окон и дверей', 'Замеры проемов, монтаж, герметизация, откосы, подоконники', 3, 4),
    -- 3. Внутренняя и наружная отделка
    ('22222222-2222-2222-2222-222222222226', '11111111-1111-1111-1111-111111111111', 'Устройство инженерных коммуникаций', 'Вода/канализация/электрика, отопление, вентиляция, освещение', 3, 5),
    ('22222222-2222-2222-2222-222222222227', '11111111-1111-1111-1111-111111111111', 'Внутренняя и наружная отделка', 'Фасад (штукатурка/покраска/облицовка, утепление) + внутренняя отделка (пол/потолок/стены, покрытия)', 3, 6),
    -- 4. Завершение работ и сдача объекта
    ('22222222-2222-2222-2222-222222222228', '11111111-1111-1111-1111-111111111111', 'Завершение работ и сдача объекта', 'Благоустройство, МАФ, приемка, регистрация', 3, 7)
ON CONFLICT (id) DO NOTHING;

-- Default tasks: substages (type=SUBSTAGE)
INSERT INTO workflow_tasks (id, stage_id, parent_id, type, name, description, position)
VALUES
    -- 1. Подготовительный этап
    ('33333333-3333-3333-3333-333333333301', '22222222-2222-2222-2222-222222222221', NULL, 'SUBSTAGE', 'Выбор участка', 'Подбор участка, проверка документов, геология', 0),
    ('33333333-3333-3333-3333-333333333302', '22222222-2222-2222-2222-222222222221', NULL, 'SUBSTAGE', 'Проектирование', 'Архитектура/план, согласования, разрешение на строительство', 1),

    -- 2. Земляные работы
    ('33333333-3333-3333-3333-333333333311', '22222222-2222-2222-2222-222222222222', NULL, 'SUBSTAGE', 'Расчистка и разметка', 'Расчистка территории, разметка осей', 0),
    ('33333333-3333-3333-3333-333333333312', '22222222-2222-2222-2222-222222222222', NULL, 'SUBSTAGE', 'Котлован/траншея', 'Устройство котлована или траншеи', 1),
    ('33333333-3333-3333-3333-333333333313', '22222222-2222-2222-2222-222222222222', NULL, 'SUBSTAGE', 'Опалубка', 'Установка опалубки', 2),
    ('33333333-3333-3333-3333-333333333314', '22222222-2222-2222-2222-222222222222', NULL, 'SUBSTAGE', 'Арматура', 'Монтаж арматуры', 3),
    ('33333333-3333-3333-3333-333333333315', '22222222-2222-2222-2222-222222222222', NULL, 'SUBSTAGE', 'Заливка бетона', 'Заливка бетонного основания', 4),

    -- Возведение стен и перекрытий
    ('33333333-3333-3333-3333-333333333321', '22222222-2222-2222-2222-222222222223', NULL, 'SUBSTAGE', 'Возведение стен', 'Несущие конструкции (кирпич/блок/дерево)', 0),
    ('33333333-3333-3333-3333-333333333322', '22222222-2222-2222-2222-222222222223', NULL, 'SUBSTAGE', 'Перекрытия', 'Межэтажные перекрытия', 1),
    ('33333333-3333-3333-3333-333333333323', '22222222-2222-2222-2222-222222222223', NULL, 'SUBSTAGE', 'Лестницы и перегородки', 'Лестницы и перегородки внутри помещений', 2),

    -- Монтаж крыши
    ('33333333-3333-3333-3333-333333333331', '22222222-2222-2222-2222-222222222224', NULL, 'SUBSTAGE', 'Стропильная система', 'Возведение стропильной системы', 0),
    ('33333333-3333-3333-3333-333333333332', '22222222-2222-2222-2222-222222222224', NULL, 'SUBSTAGE', 'Кровельное покрытие', 'Укладка кровельного покрытия', 1),
    ('33333333-3333-3333-3333-333333333333', '22222222-2222-2222-2222-222222222224', NULL, 'SUBSTAGE', 'Водосток', 'Обустройство водосточной системы', 2),
    ('33333333-3333-3333-3333-333333333334', '22222222-2222-2222-2222-222222222224', NULL, 'SUBSTAGE', 'Утепление кровли', 'Утепление кровли', 3),

    -- Установка окон и дверей
    ('33333333-3333-3333-3333-333333333341', '22222222-2222-2222-2222-222222222225', NULL, 'SUBSTAGE', 'Замеры проемов', 'Замеры проемов', 0),
    ('33333333-3333-3333-3333-333333333342', '22222222-2222-2222-2222-222222222225', NULL, 'SUBSTAGE', 'Монтаж окон/дверей', 'Установка рам и коробок', 1),
    ('33333333-3333-3333-3333-333333333343', '22222222-2222-2222-2222-222222222225', NULL, 'SUBSTAGE', 'Герметизация и откосы', 'Герметизация швов, отделка откосов, подоконники', 2),

    -- Устройство инженерных коммуникаций
    ('33333333-3333-3333-3333-333333333351', '22222222-2222-2222-2222-222222222226', NULL, 'SUBSTAGE', 'Водоснабжение', 'Прокладка водопроводных труб', 0),
    ('33333333-3333-3333-3333-333333333352', '22222222-2222-2222-2222-222222222226', NULL, 'SUBSTAGE', 'Канализация', 'Прокладка канализационных сетей', 1),
    ('33333333-3333-3333-3333-333333333353', '22222222-2222-2222-2222-222222222226', NULL, 'SUBSTAGE', 'Электрика', 'Прокладка электрических проводов', 2),
    ('33333333-3333-3333-3333-333333333354', '22222222-2222-2222-2222-222222222226', NULL, 'SUBSTAGE', 'Отопление/вентиляция/освещение', 'Монтаж приборов, вентиляции, осветительной техники', 3),

    -- Внутренняя и наружная отделка
    ('33333333-3333-3333-3333-333333333361', '22222222-2222-2222-2222-222222222227', NULL, 'SUBSTAGE', 'Фасад', 'Штукатурка/покраска/облицовка', 0),
    ('33333333-3333-3333-3333-333333333362', '22222222-2222-2222-2222-222222222227', NULL, 'SUBSTAGE', 'Утепление стен', 'Утепление наружных стен', 1),
    ('33333333-3333-3333-3333-333333333363', '22222222-2222-2222-2222-222222222227', NULL, 'SUBSTAGE', 'Внутренняя отделка', 'Пол/потолок/стены, покрытия, обои, краска', 2),

    -- Завершение работ и сдача объекта
    ('33333333-3333-3333-3333-333333333371', '22222222-2222-2222-2222-222222222228', NULL, 'SUBSTAGE', 'Благоустройство', 'Дорожки, площадки отдыха, зелёные насаждения', 0),
    ('33333333-3333-3333-3333-333333333372', '22222222-2222-2222-2222-222222222228', NULL, 'SUBSTAGE', 'МАФ', 'Малые архитектурные формы (беседки, качели, лавочки)', 1),
    ('33333333-3333-3333-3333-333333333373', '22222222-2222-2222-2222-222222222228', NULL, 'SUBSTAGE', 'Приёмка', 'Акт приёмки-передачи, устранение замечаний', 2),
    ('33333333-3333-3333-3333-333333333374', '22222222-2222-2222-2222-222222222228', NULL, 'SUBSTAGE', 'Регистрация', 'Регистрация права собственности', 3)
ON CONFLICT (id) DO NOTHING;

INSERT INTO workflow_tasks (id, stage_id, parent_id, type, name, description, position)
VALUES
    -- Выбор участка
    ('44444444-4444-4444-4444-444444444401', '22222222-2222-2222-2222-222222222221', '33333333-3333-3333-3333-333333333301', 'WORK_ITEM', 'Подбор участка', 'Подбор подходящего земельного участка с учетом всех требований и пожеланий заказчика', 0),
    ('44444444-4444-4444-4444-444444444402', '22222222-2222-2222-2222-222222222221', '33333333-3333-3333-3333-333333333301', 'WORK_ITEM', 'Проверка документов и геология', 'Проверка документов на землю, проведение геологических исследований грунта', 1),

    -- Проектирование
    ('44444444-4444-4444-4444-444444444411', '22222222-2222-2222-2222-222222222221', '33333333-3333-3333-3333-333333333302', 'WORK_ITEM', 'Архитектурный план', 'Разработка архитектурного плана будущего здания, включая фасад, интерьер и ландшафт', 0),
    ('44444444-4444-4444-4444-444444444412', '22222222-2222-2222-2222-222222222221', '33333333-3333-3333-3333-333333333302', 'WORK_ITEM', 'Разрешение и согласования', 'Получение разрешения на строительство, согласование проектной документации с местными органами власти', 1),

    -- Земляные работы
    ('44444444-4444-4444-4444-444444444421', '22222222-2222-2222-2222-222222222222', '33333333-3333-3333-3333-333333333311', 'WORK_ITEM', 'Расчистка территории', 'Расчистка территории', 0),
    ('44444444-4444-4444-4444-4444444444A1', '22222222-2222-2222-2222-222222222222', '33333333-3333-3333-3333-333333333311', 'WORK_ITEM', 'Разметка осей фундамента', 'Разметка осей фундамента', 1),
    ('44444444-4444-4444-4444-444444444422', '22222222-2222-2222-2222-222222222222', '33333333-3333-3333-3333-333333333312', 'WORK_ITEM', 'Выполнить', 'Устройство котлована или траншеи', 0),
    ('44444444-4444-4444-4444-444444444423', '22222222-2222-2222-2222-222222222222', '33333333-3333-3333-3333-333333333313', 'WORK_ITEM', 'Выполнить', 'Установка опалубки', 0),
    ('44444444-4444-4444-4444-444444444424', '22222222-2222-2222-2222-222222222222', '33333333-3333-3333-3333-333333333314', 'WORK_ITEM', 'Выполнить', 'Монтаж арматуры', 0),
    ('44444444-4444-4444-4444-444444444425', '22222222-2222-2222-2222-222222222222', '33333333-3333-3333-3333-333333333315', 'WORK_ITEM', 'Выполнить', 'Заливка бетонного основания', 0),

    ('44444444-4444-4444-4444-444444444431', '22222222-2222-2222-2222-222222222223', '33333333-3333-3333-3333-333333333321', 'WORK_ITEM', 'Выполнить', 'Несущие конструкции (кирпич/блок/дерево)', 0),
    ('44444444-4444-4444-4444-444444444432', '22222222-2222-2222-2222-222222222223', '33333333-3333-3333-3333-333333333322', 'WORK_ITEM', 'Выполнить', 'Межэтажные перекрытия', 0),
    ('44444444-4444-4444-4444-444444444433', '22222222-2222-2222-2222-222222222223', '33333333-3333-3333-3333-333333333323', 'WORK_ITEM', 'Выполнить', 'Лестницы и перегородки внутри помещений', 0),

    ('44444444-4444-4444-4444-444444444441', '22222222-2222-2222-2222-222222222224', '33333333-3333-3333-3333-333333333331', 'WORK_ITEM', 'Выполнить', 'Возведение стропильной системы', 0),
    ('44444444-4444-4444-4444-444444444442', '22222222-2222-2222-2222-222222222224', '33333333-3333-3333-3333-333333333332', 'WORK_ITEM', 'Выполнить', 'Укладка кровельного покрытия', 0),
    ('44444444-4444-4444-4444-444444444443', '22222222-2222-2222-2222-222222222224', '33333333-3333-3333-3333-333333333333', 'WORK_ITEM', 'Выполнить', 'Обустройство водосточной системы', 0),
    ('44444444-4444-4444-4444-444444444444', '22222222-2222-2222-2222-222222222224', '33333333-3333-3333-3333-333333333334', 'WORK_ITEM', 'Выполнить', 'Утепление кровли', 0),

    ('44444444-4444-4444-4444-444444444451', '22222222-2222-2222-2222-222222222225', '33333333-3333-3333-3333-333333333341', 'WORK_ITEM', 'Выполнить', 'Замеры проемов', 0),
    ('44444444-4444-4444-4444-444444444452', '22222222-2222-2222-2222-222222222225', '33333333-3333-3333-3333-333333333342', 'WORK_ITEM', 'Выполнить', 'Установка рам и коробок', 0),
    ('44444444-4444-4444-4444-444444444453', '22222222-2222-2222-2222-222222222225', '33333333-3333-3333-3333-333333333343', 'WORK_ITEM', 'Герметизация швов', 'Герметизация швов', 0),
    ('44444444-4444-4444-4444-4444444444B1', '22222222-2222-2222-2222-222222222225', '33333333-3333-3333-3333-333333333343', 'WORK_ITEM', 'Отделка откосов', 'Отделка откосов', 1),
    ('44444444-4444-4444-4444-4444444444B2', '22222222-2222-2222-2222-222222222225', '33333333-3333-3333-3333-333333333343', 'WORK_ITEM', 'Монтаж подоконников', 'Монтаж подоконников', 2),

    ('44444444-4444-4444-4444-444444444461', '22222222-2222-2222-2222-222222222226', '33333333-3333-3333-3333-333333333351', 'WORK_ITEM', 'Выполнить', 'Прокладка водопроводных труб', 0),
    ('44444444-4444-4444-4444-444444444462', '22222222-2222-2222-2222-222222222226', '33333333-3333-3333-3333-333333333352', 'WORK_ITEM', 'Выполнить', 'Прокладка канализационных сетей', 0),
    ('44444444-4444-4444-4444-444444444463', '22222222-2222-2222-2222-222222222226', '33333333-3333-3333-3333-333333333353', 'WORK_ITEM', 'Выполнить', 'Прокладка электрических проводов', 0),
    ('44444444-4444-4444-4444-444444444464', '22222222-2222-2222-2222-222222222226', '33333333-3333-3333-3333-333333333354', 'WORK_ITEM', 'Монтаж отопления', 'Монтаж отопительных приборов', 0),
    ('44444444-4444-4444-4444-4444444444C1', '22222222-2222-2222-2222-222222222226', '33333333-3333-3333-3333-333333333354', 'WORK_ITEM', 'Монтаж вентиляции', 'Монтаж вентиляционного оборудования', 1),
    ('44444444-4444-4444-4444-4444444444C2', '22222222-2222-2222-2222-222222222226', '33333333-3333-3333-3333-333333333354', 'WORK_ITEM', 'Монтаж освещения', 'Монтаж осветительной техники', 2),

    ('44444444-4444-4444-4444-444444444471', '22222222-2222-2222-2222-222222222227', '33333333-3333-3333-3333-333333333361', 'WORK_ITEM', 'Штукатурка фасада', 'Штукатурка фасада', 0),
    ('44444444-4444-4444-4444-4444444444D1', '22222222-2222-2222-2222-222222222227', '33333333-3333-3333-3333-333333333361', 'WORK_ITEM', 'Покраска фасада', 'Покраска фасада', 1),
    ('44444444-4444-4444-4444-4444444444D2', '22222222-2222-2222-2222-222222222227', '33333333-3333-3333-3333-333333333361', 'WORK_ITEM', 'Облицовка фасада', 'Облицовка декоративными материалами (сайдинг/клинкер/камень)', 2),
    ('44444444-4444-4444-4444-444444444472', '22222222-2222-2222-2222-222222222227', '33333333-3333-3333-3333-333333333362', 'WORK_ITEM', 'Выполнить', 'Утепление наружных стен', 0),
    ('44444444-4444-4444-4444-444444444473', '22222222-2222-2222-2222-222222222227', '33333333-3333-3333-3333-333333333363', 'WORK_ITEM', 'Выравнивание поверхностей', 'Выравнивание пола, потолка и стен', 0),
    ('44444444-4444-4444-4444-4444444444E1', '22222222-2222-2222-2222-222222222227', '33333333-3333-3333-3333-333333333363', 'WORK_ITEM', 'Напольные покрытия', 'Укладка напольных покрытий (ламинат/паркет/плитка)', 1),
    ('44444444-4444-4444-4444-4444444444E2', '22222222-2222-2222-2222-222222222227', '33333333-3333-3333-3333-333333333363', 'WORK_ITEM', 'Финиш стен', 'Поклейка обоев и/или нанесение краски', 2),

    ('44444444-4444-4444-4444-444444444481', '22222222-2222-2222-2222-222222222228', '33333333-3333-3333-3333-333333333371', 'WORK_ITEM', 'Дорожки и площадки', 'Организация дорожек и площадок отдыха', 0),
    ('44444444-4444-4444-4444-4444444444F1', '22222222-2222-2222-2222-222222222228', '33333333-3333-3333-3333-333333333371', 'WORK_ITEM', 'Озеленение', 'Организация зеленых насаждений', 1),
    ('44444444-4444-4444-4444-444444444482', '22222222-2222-2222-2222-222222222228', '33333333-3333-3333-3333-333333333372', 'WORK_ITEM', 'Выполнить', 'Малые архитектурные формы (беседки, качели, лавочки)', 0),
    ('44444444-4444-4444-4444-444444444483', '22222222-2222-2222-2222-222222222228', '33333333-3333-3333-3333-333333333373', 'WORK_ITEM', 'Акт приёмки-передачи', 'Оформление акта приемки-передачи заказчику', 0),
    ('44444444-4444-4444-4444-4444444444F2', '22222222-2222-2222-2222-222222222228', '33333333-3333-3333-3333-333333333373', 'WORK_ITEM', 'Устранение недостатков', 'Устранение выявленных недостатков', 1),
    ('44444444-4444-4444-4444-444444444484', '22222222-2222-2222-2222-222222222228', '33333333-3333-3333-3333-333333333374', 'WORK_ITEM', 'Выполнить', 'Регистрация права собственности', 0)
ON CONFLICT (id) DO NOTHING;
