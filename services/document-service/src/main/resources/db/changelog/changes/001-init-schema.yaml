databaseChangeLog:

  - changeSet:
      id: 001-enable-pgcrypto
      author: document-service
      changes:
        - sql:
            sql: CREATE EXTENSION IF NOT EXISTS pgcrypto;

  - changeSet:
      id: 002-document-template
      author: document-service
      changes:
        - createTable:
            tableName: document_template
            columns:
              - column:
                  name: id
                  type: uuid
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: code
                  type: varchar(100)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: name
                  type: varchar(255)
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: text
              - column:
                  name: stage_code
                  type: varchar(50)
                  constraints:
                    nullable: false
              - column:
                  name: tags
                  type: jsonb
              - column:
                  name: is_required
                  type: boolean
                  defaultValueBoolean: false
                  constraints:
                    nullable: false
              - column:
                  name: project_type
                  type: varchar(100)
              - column:
                  name: file_storage_id
                  type: varchar(512)
                  constraints:
                    nullable: false
              - column:
                  name: template_engine_type
                  type: varchar(50)
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: timestamptz
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: timestamptz
                  constraints:
                    nullable: false

        - createIndex:
            indexName: idx_template_stage_project_type
            tableName: document_template
            columns:
              - column: { name: stage_code }
              - column: { name: project_type }

  - changeSet:
      id: 003-document-group
      author: document-service
      changes:
        - createTable:
            tableName: document_group
            columns:
              - column:
                  name: id
                  type: uuid
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: project_id
                  type: uuid
                  constraints:
                    nullable: false
              - column:
                  name: type
                  type: varchar(50)
                  constraints:
                    nullable: false
              - column:
                  name: title
                  type: varchar(255)
                  constraints:
                    nullable: false
              - column:
                  name: root_document_id
                  type: uuid
              - column:
                  name: created_at
                  type: timestamptz
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: timestamptz
                  constraints:
                    nullable: false

        - createIndex:
            indexName: idx_group_project_type
            tableName: document_group
            columns:
              - column: { name: project_id }
              - column: { name: type }

  - changeSet:
      id: 004-document-instance
      author: document-service
      changes:
        - createTable:
            tableName: document_instance
            columns:
              - column:
                  name: id
                  type: uuid
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
                    nullable: false
              - column: { name: template_id, type: uuid }
              - column: { name: group_id, type: uuid }
              - column:
                  name: project_id
                  type: uuid
                  constraints:
                    nullable: false
              - column:
                  name: user_id
                  type: uuid
                  constraints:
                    nullable: false
              - column:
                  name: stage_code
                  type: varchar(50)
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: varchar(50)
                  constraints:
                    nullable: false
              - column:
                  name: version
                  type: int
                  constraints:
                    nullable: false
              - column:
                  name: current_file_storage_id
                  type: varchar(512)
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: timestamptz
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: timestamptz
                  constraints:
                    nullable: false
              - column: { name: sent_at, type: timestamptz }
              - column: { name: viewed_at, type: timestamptz }
              - column: { name: signed_at, type: timestamptz }
              - column: { name: rejected_at, type: timestamptz }
              - column: { name: due_date, type: timestamptz }

        - addForeignKeyConstraint:
            constraintName: fk_doc_instance_template
            baseTableName: document_instance
            baseColumnNames: template_id
            referencedTableName: document_template
            referencedColumnNames: id

        - addForeignKeyConstraint:
            constraintName: fk_doc_instance_group
            baseTableName: document_instance
            baseColumnNames: group_id
            referencedTableName: document_group
            referencedColumnNames: id

        - createIndex:
            indexName: idx_doc_project
            tableName: document_instance
            columns:
              - column: { name: project_id }

        - createIndex:
            indexName: idx_doc_user
            tableName: document_instance
            columns:
              - column: { name: user_id }

        - createIndex:
            indexName: idx_doc_group
            tableName: document_instance
            columns:
              - column: { name: group_id }

  - changeSet:
      id: 005-document-file-version
      author: document-service
      changes:
        - createTable:
            tableName: document_file_version
            columns:
              - column:
                  name: id
                  type: uuid
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: document_id
                  type: uuid
                  constraints:
                    nullable: false
              - column:
                  name: version
                  type: int
                  constraints:
                    nullable: false
              - column:
                  name: file_storage_id
                  type: varchar(512)
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: timestamptz
                  constraints:
                    nullable: false
              - column:
                  name: created_by_type
                  type: varchar(50)
                  constraints:
                    nullable: false
              - column: { name: created_by_id, type: uuid }

        - addForeignKeyConstraint:
            constraintName: fk_doc_file_version_document
            baseTableName: document_file_version
            baseColumnNames: document_id
            referencedTableName: document_instance
            referencedColumnNames: id
            onDelete: CASCADE

        - addUniqueConstraint:
            constraintName: uq_doc_version
            tableName: document_file_version
            columnNames: document_id, version

        - createIndex:
            indexName: idx_doc_version_doc
            tableName: document_file_version
            columns:
              - column: { name: document_id }

  - changeSet:
      id: 006-document-comment
      author: document-service
      changes:
        - createTable:
            tableName: document_comment
            columns:
              - column:
                  name: id
                  type: uuid
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: document_id
                  type: uuid
                  constraints:
                    nullable: false
              - column:
                  name: author_type
                  type: varchar(50)
                  constraints:
                    nullable: false
              - column:
                  name: author_id
                  type: uuid
                  constraints:
                    nullable: false
              - column:
                  name: text
                  type: varchar(4000)
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: timestamptz
                  constraints:
                    nullable: false

        - addForeignKeyConstraint:
            constraintName: fk_doc_comment_document
            baseTableName: document_comment
            baseColumnNames: document_id
            referencedTableName: document_instance
            referencedColumnNames: id
            onDelete: CASCADE

        - createIndex:
            indexName: idx_comment_doc
            tableName: document_comment
            columns:
              - column: { name: document_id }

  - changeSet:
      id: 007-document-signature
      author: document-service
      changes:
        - createTable:
            tableName: document_signature
            columns:
              - column:
                  name: id
                  type: uuid
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: document_id
                  type: uuid
                  constraints:
                    nullable: false
              - column:
                  name: signer_user_id
                  type: uuid
                  constraints:
                    nullable: false
              - column:
                  name: type
                  type: varchar(50)
                  constraints:
                    nullable: false
              - column:
                  name: signed_at
                  type: timestamptz
                  constraints:
                    nullable: false
              - column: { name: signature_payload, type: jsonb }
              - column:
                  name: file_hash
                  type: varchar(128)
                  constraints:
                    nullable: false

        - addForeignKeyConstraint:
            constraintName: fk_doc_signature_document
            baseTableName: document_signature
            baseColumnNames: document_id
            referencedTableName: document_instance
            referencedColumnNames: id
            onDelete: CASCADE

        - createIndex:
            indexName: idx_signature_doc
            tableName: document_signature
            columns:
              - column: { name: document_id }

  - changeSet:
      id: 008-document-audit-log
      author: document-service
      changes:
        - createTable:
            tableName: document_audit_log
            columns:
              - column:
                  name: id
                  type: uuid
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: document_id
                  type: uuid
                  constraints:
                    nullable: false
              - column:
                  name: actor_type
                  type: varchar(50)
                  constraints:
                    nullable: false
              - column: { name: actor_id, type: uuid }
              - column:
                  name: action
                  type: varchar(100)
                  constraints:
                    nullable: false
              - column: { name: payload, type: jsonb }
              - column:
                  name: created_at
                  type: timestamptz
                  constraints:
                    nullable: false

        - addForeignKeyConstraint:
            constraintName: fk_doc_audit_document
            baseTableName: document_audit_log
            baseColumnNames: document_id
            referencedTableName: document_instance
            referencedColumnNames: id
            onDelete: CASCADE

        - createIndex:
            indexName: idx_audit_doc
            tableName: document_audit_log
            columns:
              - column: { name: document_id }
